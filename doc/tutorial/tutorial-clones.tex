\section{Viewing and filtering clones}


\subsection{Looking at a clone}
\begin{verbatim}


  // #################################
  // ### Viewing and filtering clones
  // #################################

\end{verbatim}

Each RepSeq algorithm has its own definition of what a clone is (or, more precisely
a clonotype), and on how to output its sequence and how to assign a V(D)J designation.

In this file, the most abundant clone
is \texttt{IGHV3-9 7/CCCGGA/17 J6*02}.

\question{Select this clone, either by clicking on the list or on the grid.
  How many reads do this clone represent? (see again the bottom part to the right)}

\reponse{The bottom panel display information about currently selected clones \fl 189 991 reads (9.665\,\%)}

\begin{verbatim}
  // test_B_clones_01_major
  cy.selectClone('1')
  cy.get('.focus').should('have.text', "IGHV3-9*01 7/CCCGGA/17 IGHJ6*02")
  cy.get('.stats_content').should('have.text', '1 clonotype, 189 991 reads (9.665%) ')

\end{verbatim}


There are several options to display the V(D)J designation.

\question{In the  \com{settings} menu, under \com{N regions in clonotype names} select \com{length} to show N zones by their length. Revert to the
  default \com{sequence (when short)} setting to show the full N on short sequences.}

\begin{verbatim}
  ////////////////////////////////////
  // test_B_clones_02_setting_n_length
  cy.get('#menuCloneNot_nucleotide_number')
    .click({force: true})
  cy.get('#listElem_1 > .nameBox')
    .should('have.text', "IGHV3-9 7/6/17 J6*02")
  cy.get('#listElem_30 > .nameBox')
    .should('have.text', "IGHV3-13*05 1/55/16 J6*02")

  cy.get('#menuCloneNot_short_sequence')
    .click({force: true})
  cy.get('#listElem_1 > .nameBox')
    .should('have.text', "IGHV3-9 7/CCCGGA/17 J6*02")
  cy.get('#listElem_30 > .nameBox')
    .should('have.text', "IGHV3-13*05 1/55/16 J6*02")

  cy.get('#menuCloneNot_full_sequence')
    .click({force: true})
  cy.get('#listElem_1 > .nameBox')
    .should('have.text', "IGHV3-9 7/CCCGGA/17 J6*02")
  cy.get('#listElem_30 > .nameBox')
    .should('have.text', "IGHV3-13*05 1/GAGGGGGGCCTCCCTCCACCCCTCTAACCAGTGAAAAGCAAACTGGGCCCAGCGG/16 J6*02")

  cy.get('#menuCloneNot_nucleotide_number')
    .click({force: true})

\end{verbatim}

\question{Try also the options  \com{alleles in clonotype names} : by selecting \com{always}, the clone
  V gene is displayed as \com{IGHV3-9*01}. Revert to the default \com{when not
    *01}. This setting, which is the default, allows to have a more condensed
  V(D)J designation that doesn't make the \com{*01} appear (it is implicit).}


\begin{verbatim}
  //////////////////////////////////
  // test_B_clones_03_setting_allele
  cy.get('#menuAlleleNot_never')
    .click({force: true})
  cy.get('#listElem_1 > .nameBox')
    .should('have.text', "IGHV3-9 7/6/17 J6")

  cy.get('#menuAlleleNot_when_not_01')
    .click({force: true})
  cy.get('#listElem_1 > .nameBox')
    .should('have.text', "IGHV3-9 7/6/17 J6*02")

  cy.get('#menuAlleleNot_always')
    .click({force: true})
  cy.get('#listElem_1 > .nameBox')
    .should('have.text', "IGHV3-9*01 7/6/17 J6*02")

  cy.get('#menuAlleleNot_when_not_01')
    .click({force: true})

\end{verbatim}

\subsection{Showing more clones}

By default Vidjil displays the 50 most abundant clones at each time point.
With five time points, we may therefore have from 50 to 250 clones displayed
depending if the top 50 are always the same or always different or, more
realistically, in-between.
This number can be increased to a maximum of 100 clones by going to the \com{filter} menu and by putting the
slider to its right end.
\question{Notice how the IGH smaller clonotypes percentage (second clone displayed in the list) changes. What was its
  initial value? What is it now?}

\reponse{filter set to 50 \fl IGH smaller clonotypes 10.11\,\%\\*
 filter set to 100 \fl IGH smaller clonotypes 8.92\,\%\\*}
\begin{verbatim}
  /////////////////////////////////
  // test_B_clones_04_filter_slider
  // Igh smaller position: 454


  cy.getCloneSize("454").should('have.text', "10.11%")
  cy.getCloneInList('308').should("not.visible")

  cy.getSliderTop().invoke("val", 100)
    .trigger("change", { force: true })
    .click({ force: true })
    // small clone is present in list (after slider increase)

  cy.getCloneInList('308').should("exist")

  cy.getCloneInList('309').should("not.visible") //"Not all real clones are present in list"
  cy.getCloneSize("454").should('have.text', "8.920%")


  cy.getSliderTop().invoke("val", 50)
    .trigger("change", { force: true })
    .click({ force: true })
  cy.getCloneSize("454").should('have.text', "10.11%")
  cy.getCloneInList('308').should("not.visible")


\end{verbatim}

The \textit{smaller clonotypes} correspond to clones that are not displayed
because they are never among the most abundant ones.


\subsection{Tagging and filtering clones}

Consider the most abundant clones in the list:  \texttt{IGHV3-9 7/CCCGGA/17 J6*02} and  \texttt{TRGV10 13//5 JP1}.
Usually we may want to tag them in order to remember them later on.
\question{Click on the star and choose colored tags for these two clones, such as \texttt{clonotype 1} or \texttt{clonotype 2}.
  Notice how the color applies throughout all the views.}

\begin{verbatim}
  // test_B_clones_05_tag_biggest_clone

  // control default color of clones
  cy.getCloneInList(0).should('have.css', 'color', 'rgb(101, 123, 131)')

  // Tag multiple times one clonotype
  cy.changeTagClone(1, 'clonotype_1')
  cy.changeTagClone(4, "clonotype_2")
  cy.changeTagClone(0, "standard_2")

  cy.selectClone("5") // select other clone to see real color of clone 0
  cy.getCloneInList(0).should('have.css', 'color', 'rgb(108, 113, 196)')


\end{verbatim}

Later you may want to filter clones depending on the tags you have chosen.

\question{In the upper left part, click on the little dark gray square (the
  second coloured square starting from the right). What happens? What if you click again?}

\begin{verbatim}
  // test_B_clones_06_filter_by_tag

  cy.get('#listElem_454 > .nameBox')
    .scrollIntoView()

  cy.get('#listElem_1')
    .should("be.visible")

  cy.getCloneInList("1")
  cy.switchTag("clonotype_1")

  cy.getCloneInList('1').should("not.be.visible")

  cy.switchTag("clonotype_1")
  cy.getCloneInList('1').should("be.visible")


\end{verbatim}

This is a way of filtering some clones. This may be useful when we want to
focus on some specific clones. Another way of doing so is to filter them by
their gene names or by their DNA sequences.  
\question{In the search box,
  enter \texttt{GGAGTCGGGG} and validate with \texttt{Enter}.  How many sequences are
  left?}


\begin{verbatim}
  //////////////////////////////////
  // test_B_clones_06b_filter_by_tag
  // TODO

\end{verbatim}

Note that the search is performed both on the forward and the reverse strand.
\question{Check that by searching for the reverse complement of the
  sequence: \texttt{CCCCGACTCC}. Do you find the same results as previously?}
\question{How can you cancel this filter and view again all the clones?}

\begin{verbatim}
  // test_B_clones_07_filter_search_area

  // cy.getCloneInList('0').should("be.visible")
  cy.getCloneInList('1').should("be.visible")
  cy.getCloneInList('454').should("be.visible")


  cy.filterSearch('CCCCGACTCC')

  // cy.getCloneInList('0').should("not.be.visible")
  cy.getCloneInList('1').should("not.be.visible")
  cy.getCloneInList('454').should("not.be.visible")

  //clones that should stay present (19 clones, test somes)
  cy.getCloneInList('6').scrollIntoView().should("be.visible")
  cy.getCloneInList('142').scrollIntoView().should("be.visible")
  cy.getCloneInList('51').scrollIntoView().should("be.visible")
  cy.getCloneInList('52').scrollIntoView().should("be.visible")
  cy.getCloneInList('16').scrollIntoView().should("be.visible")

  cy.filterSearchReset()
  cy.getCloneInList('1').scrollIntoView().should("be.visible")
  cy.getCloneInList('454').scrollIntoView().should("be.visible")


\end{verbatim}  
\bigskip

Another solution to tag a specific clone is to rename it.
\question{Double click on the name of a clone (in the list of clones) and
  choose another name (\textit{e.g.} interesting clone) and validate using
  \texttt{Enter}.}
\begin{verbatim}
  // test_B_clones_08_change_clone_name

  cy.getCloneInList('1')
    .dblclick()
  cy.get('#new_name')
    .type("interesting clone")
  cy.get('#btnSave').click()

  cy.getCloneInList('1')
    .should('have.text', "interesting clone")

\end{verbatim}

\bigskip

After this rename, you can see that the clone is still selected.
\question{Click on several clones by holding the \texttt{Ctrl} key to select
  more. Each time you add a new clone to the selection, its sequence
  is added in the bottom part.}
\begin{verbatim}
  //////////////////////////////////
  // test_B_clones_09_multiselection
    cy.changePreset("read length distribution")
    // to verify correct selection, We will look in segmenter the presence if clone entrie
    // Maybe another method could be more acurate

    cy.selectClone("1")
    cy.getCloneInSegmenter('0').should("not.be.visible") //Clone 0 should not be present anymore in segmenter
    cy.getCloneInList('1').should("be.visible") // Correct selection of clone 1 after second click in scatterplot

    cy.selectCloneMulti([0, 1])
    cy.getCloneInSegmenter(0)
    cy.getCloneInSegmenter(1)

\end{verbatim}

\question{How many clones are selected? How many reads do those clones
  represent?}
\begin{verbatim}
  //////////////////////////////////////////////
  // test_B_clones_10_size_if_multiple_selection
    cy.selectCloneMulti([1, 4])
    cy.get('.stats_content').should('have.text', '2 clonotypes, 364 027 reads (18.51%) ')


\end{verbatim}

\question{ Notice the star at the the right of the screen, near the number
  of reads. You can also tag clones using this icon. In that way, you will be able to tag
  all the selected clones at once.}
\begin{verbatim}
  ////////////////////////////////
  // test_B_clones_11_multiple_tag
    cy.selectCloneMulti([7, 11, 13])
    cy.get('#tag_icon__multiple').click()
    cy.get('#tagElem_custom_2').click()
    cy.selectClone(0)

    cy.getCloneInList(5).should('have.css', 'color', 'rgb(101, 123, 131)') // clone 5 still have default color
    cy.getCloneInList(7).should('have.css', 'color', 'rgb(211, 54, 130)') // clone 7 have also changed color
    cy.getCloneInList(11).should('have.css', 'color', 'rgb(211, 54, 130)') // clone 11 have also changed color
    cy.getCloneInList(13).should('have.css', 'color', 'rgb(211, 54, 130)') // clone 13 have also changed color


\end{verbatim}

\question{When you want to focus on the selected clones, you can click on the
  focus link on the right, next to the number of selected clones.
  This feature is useful when you want to analyse some clones more thoroughly
  without being annoyed by other clones.}
\begin{verbatim}
  /////////////////////////
  // test_B_clones_12_focus
    cy.getCloneInList(1).should("be.visible")
    cy.getCloneInList(7).should("be.visible")
    cy.getCloneInList(11).should("be.visible")

    cy.selectCloneMulti([1, 7, 11])
    cy.focusOnSelection()

    cy.getCloneInList(1).should("be.visible")
    cy.getCloneInList(7).should("be.visible")
    cy.getCloneInList(11).should("be.visible")
    cy.getCloneInList(5).should("not.be.visible")


\end{verbatim}

\question{To remove this focus, click on the cross next to the search box,
  above the list.}
\begin{verbatim}
  /////////////////////////////////
  // test_B_clones_13_remove_filter
    cy.resetAllFilter()
    cy.getCloneInList(1).should("be.visible")
    cy.getCloneInList(7).should("be.visible")
    cy.getCloneInList(11).should("be.visible")
    cy.getCloneInList(5).should("be.visible")


\end{verbatim}

\question{To unselect them all, you can click in an empty area on the top or
  bottom plot.}
\begin{verbatim}
  ///////////////////////////////////////////////////
  // test_B_clones_14_unselect_by_click_in_empty_zone
    // TODO


\end{verbatim}

Sometimes, one wants to hide noisy or unrelated clones.

\question{Select a clone or several clones and click on the \com{hide} button, near the \com{focus} button. Show again these
  clones by clicking on the cross next to the search box.}
\begin{verbatim}
  /////////////////////////////////
  // test_B_clones_15_hide_selected
    // test that clone are present before focus
    cy.getCloneInList(1).should("be.visible")
    cy.getCloneInList(7).should("be.visible")
    cy.getCloneInList(11).should("be.visible")

    // select somme clones (7, 11, 13)
    cy.selectCloneMulti([7, 11])
    cy.hideSelection()
    cy.getCloneInList(1).should("be.visible")
    cy.getCloneInList(7).should("not.be.visible")
    cy.getCloneInList(11).should("not.be.visible")
    
    // test that clone are present after resetting filtering
    cy.resetAllFilter()
    cy.getCloneInList(1).should("be.visible")
    cy.getCloneInList(7).should("be.visible")
    cy.getCloneInList(11).should("be.visible")


\end{verbatim}

% Another way to hide clonesis to assign is to change the tag of it as ``standard (niose)`` and choose to uncheck this tag by clicking on the corresponding tile on the list of tiles at the informatons panel to switch them from a visible state to a filter one.
%%% Voir ci-dessus, déjà mis

It is also possible to filter samples that do not contain a clone.  When you
have lots of samples it helps to keep the sample of interest.  Here the number
of sample is quite limited, so the feature may appear less useful.

\question{\new Click on the \com{IGHV3-11 / IGHJ6} clone in the last sample, whose
  abundance is around 10\,\%.
  Then go in the menu at the upper-right corner of the graph (where \com{5/5}
  is written) and select \com{focus on selected clones}.
}
\begin{verbatim}
  ////////////////////////////////////
  // test_B_clones_16_graphmenu_filter
    cy.getCloneInList(5).should("be.visible")
    cy.get('#visu2_title').should("have.text", "5 / 5")
    cy.get('#time0').should("be.visible")

    cy.get('#visu2_listElem_check_0').should('be.checked')
    cy.get('#visu2_listElem_check_2').should('be.checked')

    cy.selectClone(5)
    cy.get('#visu2_listElem_hideNotShare').click({force: true})

    cy.get('#visu2_title').should("have.text", "3 / 5")
    cy.get('#visu2_listElem_check_0').should('not.be.checked')
    cy.get('#visu2_listElem_check_2').should('be.checked')


\end{verbatim}

By selecting this, the samples where this clone doesn't appear are hidden.
This is useful for instance to assess the contamination among dozens of
samples.

\question{You can go back to the previous view by returning into the menu and
  clicking on \com{show all}. Notice also how in the menu you can select the
  samples to be shown.}
\begin{verbatim}
  //////////////////////////////////////
  // test_B_clones_17_graphmenu_activate
    cy.get('#visu2_title').should("have.text", "3 / 5") //Ratio show is correct after focus

    cy.get('#visu2_listElem_check_0').click({force: true})
    cy.update_icon()
    cy.get('#visu2_listElem_check_0').should('be.checked')
    cy.get('#time0').should("be.visible")    // Test "first sample is NOT present in timeline after click"
    cy.get('#visu2_title').should("have.text", "4 / 5") //Ratio show is correct after checkbox clicking

    cy.get('#visu2_listElem_showAll').click({force: true})
    cy.get('#visu2_title').should("have.text", "5 / 5") //Ratio show is correct after checkbox clicking

    cy.get('#visu2_listElem_check_0').should('be.checked')
    cy.get('#visu2_listElem_check_1').should('be.checked')
    cy.get('#visu2_listElem_check_2').should('be.checked')


\end{verbatim}

\section{Analysing clone populations}

\subsection{Clustering clones through inspection of their sequences}

The first thing to be done is to see if some clones should be clustered (because
of sequencing or PCR errors for instance). This step could be automatized
but, in any case, the automatic clustering would need to be checked by an expert
eye.

By default in the bottom plot (the \textit{grid}), the clones
  are displayed according to their V and J genes (or more generally to their
  5' and 3' genes). 

\question{Identify in the grid the clones with an
  \textit{IGHV-3-13}~\textit{IGHJ6} recombination and select them
  all. You can do so either by holding \texttt{Ctrl} or by drawing a rectangle around the clones while
  maintaining down the left button of the mouse.}
\begin{verbatim}
  /////////////////////////////////////////////////////
  // test_B_clones_18_select_mulitple_ighv3_13_clonotype
    cy.selectClone(0)
    cy.get("body").type("0")

    cy.get('#id_label_x_IGHV3-13').click()

    // control that these clonotype is selected and visible in semgenter
    cy.getCloneInSegmenter(0).should("not.be.visible") // should not be present
    cy.getCloneInSegmenter(30)
    cy.getCloneInSegmenter(43)
    cy.getCloneInSegmenter(47)


\end{verbatim}

The sequences of the clones now appear in the bottom part of the browser (the
\textit{sequence panel}). If many clones are selected you can view more sequences
by moving the mouse above the sequence panel.
 In such a case, you may be bothered by the sequence panel going up and
down each time your mouse enters or exits the sequence panel. You can stick it
in its current shape by clicking on the pin at the upper right corner of the
sequence panel.

Then, the sequences in the sequence panel can be visually compared but you can also align
them to see more easily their similarities.


\question{Click on the \com{align} button on the left-hand side. The differences are
emphasized in bold.}
\begin{verbatim}
  /////////////////////////
  // test_B_clones_19_align
    // TODO; align don't available without server


\end{verbatim}

Now it is the user's expertise to determine if sequences are sufficiently
similar, depending on her or his specific question. If some sequences don't appear to be similar enough, you can remove
them from the sequence panel by clicking on the cross in front of the sequence in
the sequence panel.
\question{Remove all the sequences that are not similar enough with the first
  one.}
\begin{verbatim}
  ///////////////////////////////////////////
  // test_B_clones_20_unselect_from_segmenter
    cy.removeCloneInSegmenter(47) // automatic assert not visible


\end{verbatim}

Now all the sequences in the sequence panel should be highly similar. All their
differences could be due to sequencing or PCR errors.
These artifacts (mutations, homopolymers, insertions, deletions)
depend on the sequencer and the PCR technique.

\question{Cluster all those clones in a single clone by clicking on the ``cluster''
  button, next to the \com{align} button.}
\begin{verbatim}
  //////////////////////////////////
  // test_B_clones_21_click_on_merge
    cy.getCloneInSegmenter(30).should("be.visible")
    cy.getCloneInSegmenter(43).should("be.visible")
    cy.get('#cluster').click()
    cy.update_icon()

    cy.getCloneInSegmenter(30).should("be.visible")
    cy.getCloneInSegmenter(43).should("not.be.visible")


\end{verbatim}

All the clustered sequences now appear within a same clone. That can be seen
in the list: the clone which hosts the subclones appears with a $+$ on its
left. You can click on the $+$ to see the subclones that have been clustered in
the main one.
\question{Click on the $+$ and observe the changes in the grid.}
\begin{verbatim}
  ///////////////////
  // test_B_clones_22
    // TODO


\end{verbatim}

As you may have noticed the subclones appear again in the grid. You can
compare their sequences again if you'd like (for example to double check that
you were right to cluster them). You can also remove some subclones from the
cluster by clicking on the cross at their left in the list.
\question{For the sake of the exercise, remove the last clone of the cluster.}
\begin{verbatim}
  ///////////////////
  // test_B_clones_23
    // TODO


\end{verbatim}

\question{%
%For the next step, choose the preset \com{V distribution} (keyboard shortcut \com{5}).
% On n'a pas encore parlé ici des presets. 
Open the \com{cluster} menu, and choose \com{cluster by V/5}. What happened ? There are now two clones with TRGV2. Why ?}
%%  Confirm this by changing the x axis into ``V allele``.
%%% -> Problème, on n'a pas encore parlé des axes à cet endroit.
\begin{verbatim}
  ////////////////////////////////
  // test_B_clones_24_cluster_by_V
    cy.getCloneInList(1).should("not.have.text", "IGHV3-9")
    cy.get('#clusterBox_1 > .icon-plus').should("not.exist")

    cy.get("#clusterBy_5").click({force: true})
    cy.update_icon()

    cy.getCloneInList(1).should("have.text", "IGHV3-9")
    cy.get('#clusterBox_1 > .icon-plus').should("exist")
    cy.getCloneInList(4).should("have.text", "TRGV10")
    cy.get('#clusterBox_4 > .icon-plus').should("exist")


\end{verbatim}

\question{In the \com{cluster} menu, select  \com{revert to previous clusters} to undo these clusterings.}
\begin{verbatim}
  ///////////////////
  // test_B_clones_25
    cy.get('#cluster_break_all').click({force: true})
    cy.getCloneInList(1).should("have.text", "interesting clone")
    cy.get('#clusterBox_1 > .icon-plus').should("not.exist")
    cy.getCloneInList(4).should("have.text", "TRGV10 13//5 JP1")
    cy.get('#clusterBox_4 > .icon-plus').should("not.exist")


\end{verbatim}

\subsection{Other metrics and analysis on the clones}

As a proxy to sequence similarity we used the V and J genes, however there are
other ways to assess sequence similarity that may be more pertinent.
Moreover you may want to plot other metrics on the lymphocyte population.
%
For instance we can choose to plot the V genes versus the length of the N
insertions.
\question{Go to the \com{plot} menu (in the upper left corner of the grid),
  and in the preset box choose \com{V/N length}.}
\begin{verbatim}
  ///////////////////////////////////////
  // test_B_clones_26_change_scatter_axis
    // change preset, first time manually as user can do (don't use $b.scatterplot_select_preset this time)
    cy.changePreset("V/N length")

    cy.get('#id_legend_x').should("have.text", "V/5' gene")
    cy.get('#id_legend_y').should("have.text", "N length")

    cy.get('#id_label_x_IGHV1-2').should("exist").should("be.visible")
    cy.get('#id_label_y_\\?').should("exist").should("be.visible")


\end{verbatim}

Then you can continue aligning and clustering clones if necessary.

\question{You can also try the preset \com{read length/GC content}
  which tends to separate quite nicely the distinct clones.}
\begin{verbatim}
  ///////////////////////////////////
  // test_B_clones_27_change_preset_2
    cy.changePreset("read length / GC content")

    cy.get('#id_legend_x').should("have.text", "Reads length")
    cy.get('#id_legend_y').should("have.text", "GC content")

    cy.get('#id_label_x_\\?').should("exist").should("be.visible")


\end{verbatim}

Note that you can choose any axis to be plotted: just go the \com{plot} menu and
select any value you would like for the $x$ axis and for the $y$ axis.
For bar charts, the box sizes always relates to the clone size,
and the $y$ axis selects the order of the boxes sharing a same $x$).

%% \item Regarder les stats disponibles, mettre n°7 (taille des reads)

\question{In the \com{plot} menu, switch between the ``bubble plot'' and the ``bar plot''.
In the bar plot mode, pass the mouse over the bars: What happens?}
\begin{verbatim}
  ///////////////////////////////////////////
  // test_B_clones_28_switch_scatterplot_mode

    cy.get("body").type(0)
    cy.update_icon()

    cy.get('#id_legend_x').should("have.text", "V/5' gene")
    cy.get('#id_legend_y').should("have.text", "J/3' gene")

    cy.get("#visu_bar").click({force: true})

    cy.get('#id_legend_x').should("have.text", "V/5' gene") // Correct legend for axe X after switch in bar mode
    cy.get('#id_legend_y').should("have.text", "Size")      // Correct legend for axe Y after switch in bar mode

    cy.get("#visu_plot").click({force: true})
    cy.get('#id_legend_x').should("have.text", "V/5' gene") // Correct legend for axe X after switch back in bubble mode"
    cy.get('#id_legend_y').should("have.text", "J/3' gene") // Correct legend for axe Y after switch back in bubble mode"


\end{verbatim}

% Another possibility is to request Vidjil to compute the similarity between
% clones.
% \question{Now select the preset \com{plot by similarity} or even \com{plot
%   similarity by locus} to plot similarity for the current locus (beware: this
% may take some time).}
% Now the most similar clones should be close together. However note that it is
% theoretically impossible to achieve such a representation in 2 dimensions. So
% it is possible that two dissimilar clones are close together or, conversely,
% that two similar clones are far apart.

\question{Press the keys \texttt{0} to \texttt{9} on the numeric keypad. What happens ?}
\begin{verbatim}
  ///////////////////////////////////
  // test_B_clones_29_shortcut_preset

    cy.get("body").type(0)
    cy.get('#id_legend_x').should("have.text", "V/5' gene") // Correct legend for axe X for preset 0
    cy.get('#id_legend_y').should("have.text", "J/3' gene") // Correct legend for axe Y for preset 0
    // cy.get("#id_label_x_IGHV1-2") // scatterplot_legend X at init; IGHV1-2
    // cy.get("#id_label_y_IGHJ1")   // scatterplot_legend Y at init; IGHJ-1

    cy.get("body").type(1)
    cy.get('#id_legend_x').should("have.text", "V/5' allele") // Correct legend for axe X for preset 1
    cy.get('#id_legend_y').should("have.text", "J/3' allele") // Correct legend for axe Y for preset 1
    // cy.get("#id_label_x_IGHV1-2*04") // scatterplot_legend X with shortcut/preset XXX is: IGHV1-2
    // cy.get("#id_label_y_IGHJ1")      // scatterplot_legend Y with shortcut/preset XXX is: IGHJ-1


    cy.get("body").type(2)
    cy.get('#id_legend_x').should("have.text", "V/5' gene") // Correct legend for axe X for preset 2
    cy.get('#id_legend_y').should("have.text", "N length")  // Correct legend for axe Y for preset 2
    // cy.get("#id_label_x_IGHV1-2") // scatterplot_legend X with shortcut/preset XXX is: IGHV1-2
    // cy.get("#id_label_y_\\?")     // scatterplot_legend Y with shortcut/preset XXX is: IGHJ-1

    cy.get("body").type(3)
    cy.get('#id_legend_x').should("have.text", "Reads length") // Correct legend for axe X for preset 3
    cy.get('#id_legend_y').should("have.text", "Locus")        // Correct legend for axe Y for preset 3
    // cy.get("#id_label_x_20")  // scatterplot_legend X with shortcut/preset XXX is: IGHV1-2
    // cy.get("#id_label_y_IGH") // scatterplot_legend Y with shortcut/preset XXX is: IGHJ-1

    cy.get("body").type(4)
    cy.get('#id_legend_x').should("have.text", "Reads length") // Correct legend for axe X for preset 4
    cy.get('#id_legend_y').should("have.text", "Size")         // Correct legend for axe Y for preset 4
    // cy.get("#id_label_x_20")   // scatterplot_legend X with shortcut/preset XXX is: IGHV1-2
    // cy.get("#id_label_y_20\%") // scatterplot_legend Y with shortcut/preset XXX is: IGHJ-1

    cy.get("body").type(5)
    cy.get('#id_legend_x').should("have.text", "V/5' gene") // Correct legend for axe X for preset 5
    cy.get('#id_legend_y').should("have.text", "Size")      // Correct legend for axe Y for preset 5
    // cy.get("#id_label_x_IGHV1-2") //scatterplot_legend X with shortcut/preset XXX is: IGHV1-2
    // cy.get("#id_label_y_16\%")    //scatterplot_legend Y with shortcut/preset XXX is: IGHJ-1

    cy.get("body").type(6)
    cy.get('#id_legend_x').should("have.text", "N length") // Correct legend for axe X for preset 6
    cy.get('#id_legend_y').should("have.text", "Size")     // Correct legend for axe Y for preset 6
    // cy.get("#id_label_x_\\?")  // scatterplot_legend X with shortcut/preset XXX is: IGHV1-2
    // cy.get("#id_label_y_55\%") // scatterplot_legend Y with shortcut/preset XXX is: IGHJ-1

    cy.get("body").type(7)
    cy.get('#id_legend_x').should("have.text", "CDR3 length") // Correct legend for axe X for preset 7
    cy.get('#id_legend_y').should("have.text", "Size")        // Correct legend for axe Y for preset 7
    // cy.get("#id_label_x_") // scatterplot_legend X with shortcut/preset XXX is: IGHV1-2
    // cy.get("#id_label_y_") // scatterplot_legend Y with shortcut/preset XXX is: IGHJ-1

    cy.get("body").type(8)
    cy.get('#id_legend_x').should("have.text", "J/3' gene") // Correct legend for axe X for preset 8
    cy.get('#id_legend_y').should("have.text", "Size")      // Correct legend for axe Y for preset 8
    // cy.get("#id_label_x_") // scatterplot_legend X with shortcut/preset XXX is: IGHV1-2
    // cy.get("#id_label_y_") // scatterplot_legend Y with shortcut/preset XXX is: IGHJ-1

    cy.get("body").type(9)
    cy.get('#id_legend_x').should("have.text", "Size")         // Correct legend for axe X for preset 9
    cy.get('#id_legend_y').should("have.text", "Size (other)") // Correct legend for axe Y for preset 9
    // cy.get("#id_label_x_") // scatterplot_legend X with shortcut/preset XXX is: IGHV1-2
    // cy.get("#id_label_y_") // scatterplot_legend Y with shortcut/preset XXX is: IGHJ-1

    cy.get("body").type(0)
    cy.get('#id_legend_x').should("have.text", "V/5' gene") // Correct legend for axe X for preset 0
    cy.get('#id_legend_y').should("have.text", "J/3' gene") // Correct legend for axe Y for preset 0
    // cy.get("#id_label_x_IGHV1-2")// scatterplot_legend X with shortcut/preset XXX is: IGHV1-2
    // cy.get("#id_label_y_\\?")    // scatterplot_legend Y with shortcut/preset XXX is: IGHJ-1

\end{verbatim}

There is still a feature to help you analyse your data that we have not
explored yet.
You can change the colors to make it represent some variables of interest
with the \com{color by} menu.
\question{First choose the preset \com{V/J (genes)} and
  then color by \com{N length} (in the box at the top of the screen).}
\begin{verbatim}
  //////////////////////////////
  // test_B_clones_30_color_mode

    cy.changePreset("V/J (genes)")
    cy.get("#id_label_x_IGHV1-2") // scatter plot legend X is correct after preset change
    cy.get("#id_label_y_IGHJ1")   // scatter plot legend Y is correct after preset change

    // control color state at init
    cy.get('.gradient').should('not.exist')
    cy.changeColorby("N length")
    cy.get('.gradient').should('exist')

    // control
    cy.getCloneInList(1).should('have.css', 'color', 'rgb(0, 189, 225)')
    cy.getCloneInList(4).should('have.css', 'color', 'rgb(0, 173, 251)')


\end{verbatim}
  
\marginpar{We apologize to color blinds: the colors are not yet color-blind friendly.}Clones that are close on the grid with similar colors are likely to
be similar.

\question{Choose now the preset \com{CDR3 length distribution} and
  then color by \com{size}.
  See that the color tiles in the info part (upper right) change to show the color key.}
\begin{verbatim}
  //////////////////////////////////
  // test_B_clones_31_color_gradient

    cy.changePreset("CDR3 length distribution")
    cy.changeColorby("Size")
    cy.update_icon()

    cy.get('.gradient').should('exist')


\end{verbatim}

\question{ Instead of coloring by clone size, you could also color by
  \com{clonotype}. When coloring by \com{clonotype}, each clone has a random color. Thus in
  a bar plot, it is a convenient color mode to see the peaks that are due to a
  single clone or to several clones.
  However clones may be very similar. Another option is to color by
  \com{CDR3}. In such case all clones with the same CDR3 will have the same
  color (note that, due to a lack of available colors two different CDR3s
  could share the same color just by chance).}
\begin{verbatim}
  //////////////////////////////////
  // test_B_clones_32_color_by_clone
    cy.changeColorby("Clonotype")
    cy.update_icon()

    cy.selectClone(0)
    cy.getCloneInList(1).should('have.css', 'color', 'rgb(153, 153, 61)')
    cy.getCloneInList(4).should('have.css', 'color', 'rgb(61, 61, 153)')


\end{verbatim}


Using those different features you should be able to analyse how similar your
sequences are, and potentially you could cluster them if you'd like or tag them.

\question{
  Select the most abundant clone. It now appears in the sequence panel.
  Now we would like to compare the sequence with the germline genes.
  We can add the germline genes to the sequence panel by going
  to the \com{import/export} menu and by clicking on \com{add germline genes}.
  Now we can click on the \com{align} button to see the alignment between the
  genes and the sequence. Mutations can be identified and silent mutations are
  displayed with a double border in blue.
}
\begin{verbatim}
  //////////////////////////////////
  // test_B_clones_33_align_germline

    // sequence germline is NOT present in the segmenter
    cy.get('#seqIGHJ6\*02 > .sequence-holder > .seq-fixed > .nameBox').should("not.exist")

    cy.selectClone(1)
    cy.get("#export_add_germline").click({force: true})

    cy.get('#seqIGHJ6\\*02 > .sequence-holder > .seq-fixed > .nameBox').should("exist")
    // todo, align; mutation; not available without server side


\end{verbatim}

\bigskip

\textit{This part is specific to samples analyzed with Vidjil-algo.}

Some clones may be less trustable than other ones\dots{} Let's see how to spot them.
\question{In the clone list, search clones with an orange warning at the
  right side. Click on the warning. What are the warnings due to?}
\begin{verbatim}
  ///////////////////
  // test_B_clones_34
    cy.selectClone(11)
    cy.get('#clone_infoBox_1  > .icon-warning-1').should("not.exist")
    cy.get('#clone_infoBox_11 > .icon-warning-1').should("exist")

    cy.openCloneInfo("11")

    cy.get('#clone_info_table_11')
      .should("exist")
      //.should("be.visible") // bottom part of table is covered; don't work

    cy.get('#modal_line_title_W53')
      .should("exist")
      .should("be.visible")
    cy.get('#modal_line_value_W53')
      .should("have.text", "Similar to clone #2 - TRGV10*01 13//5 TRGJP1*01")

    cy.closeCloneInfo()


\end{verbatim}

There may have several reasons: 
\begin{itemize}
\item average coverage: in that case the clonal sequence displayed is short
  compared to the reads in the clone. This may be the case when too different
  sequences have been put in a clone. The value is generally $\geq 80\,\%$.
\item $e$-value: It is a statistical value computed to ensure that
  recombinations have not been spot by chance. This value is generally much
  lower than 1 ($<10^{-5}$).
\item Clone similar to another one: In that case Vidjil-algo tells you that
  other clones have the same genes and may be similar
\item Non-recombined sequences: Some known unrecombined sequences are tagged
  so that you can spot them easily. We tag the unrecombined IGHD7-27/IGHJ1
  sequences that may be amplified.
\end{itemize}

You can view those values for any clone by clicking the \textit{i} icon on the
right side, in the list of clones.
\subsection{Analysing recombinations from several loci}

First make sure to come back to the preset \com{V/J (genes)} in the \com{plot} menu.

If you want to focus on specific locus, you can click on the locus name in
the upper left part. One click will make the locus disappear, another one will
make it appear again.
If you hold the \texttt{Shift} key (the one which is usually above the left
\texttt{Ctrl} key) while clicking it will hide all the loci but the one you
clicked on.

\question{Click on \com{IGH}, while holding the \texttt{Shift} key. Now what is the
  number of analyzed reads? Why did it change?}
\begin{verbatim}
  ////////////////////////////////
  // test_B_clones_35_locus_switch
    cy.get('#toogleLocusSystemBox_TRG').should('not.have.class', 'unchecked')
    cy.get('#toogleLocusSystemBox_IGH').should('not.have.class', 'unchecked')

    cy.get('#toogleLocusSystemBox_IGH').click({shiftKey: true})

    cy.get('#toogleLocusSystemBox_TRG').should('have.class', 'unchecked')     // locus TRG NOT present in info panel after switch
    cy.get('#toogleLocusSystemBox_IGH').should('not.have.class', 'unchecked') // locus IGH present in info panel after switch


\end{verbatim}

\question{Now click on \com{TRG}, to filter it in again.}
\begin{verbatim}
  ////////////////////////////////////////
  // test_B_clones_36_activate_again_locus
    cy.get('#toogleLocusSystemBox_TRG').click()
    cy.get('#toogleLocusSystemBox_TRG').should('not.have.class', 'unchecked')
    cy.get('#toogleLocusSystemBox_IGH').should('not.have.class', 'unchecked')

\end{verbatim}

\question{Press on the \texttt{g} key. What happens? Now, press on the
  \texttt{h} key. Press on the \texttt{g} again (you can do that anytime you
  like :)). Let's stick to the TRG locus.}
\begin{verbatim}
  ////////////////////////////
  // test_B_clones_37_shortcut
    cy.get("body").type(0) // return to a grap with locus 
    cy.get('#id_label_x_IGHV1-2').should("exist").should("be.visible")
    cy.get('#id_label_y_IGHJ1').should("exist").should("be.visible")

    cy.get("body").type("g") // locus TRG
    cy.get('#id_label_x_TRGV2').should("exist").should("be.visible")
    cy.get('#id_label_y_TRGJ1').should("exist").should("be.visible")

    cy.get("body").type("h") // locus IGH
    cy.get('#id_label_x_IGHV1-2').should("exist").should("be.visible")
    cy.get('#id_label_y_IGHJ1').should("exist").should("be.visible")


\end{verbatim}

You can also change the current locus by clicking on the locus name in the
right part of the grid.
\begin{verbatim}
  /////////////////////////////////////////////////////
  // test_B_clones_38_switch_locus_by_scatterplot_click
    cy.get("body").type(0) // locus IGH
    cy.get('#id_label_x_IGHV1-2').should("exist").should("be.visible") // scatterplot_legend X at init; IGHV1-2
    cy.get('#id_label_y_IGHJ1').should("exist").should("be.visible")   // scatterplot_legend Y at init; IGHJ-1

    cy.get('#id_sp_system_label_TRG > .sp_system').click()
    cy.get('#id_label_x_TRGV2').should("exist").should("be.visible")
    cy.get('#id_label_y_TRGJ1').should("exist").should("be.visible")


\end{verbatim}

\subsection{Clone quantification (using spike-ins)}

Sometimes you may include spike-ins in your sample to allow a more reliable
quantification.
Let us assume that the main clone with IGHV-3-9 / IGHJ5 is a spike-in whose
expected concentration is 1\% (.01).

\question{First let's color this clone with the \com{standard} tag.}
\begin{verbatim}
  ///////////////////////////////////
  // test_B_clones_39_reset_color_tag
    cy.changeColorby("Tag")
    cy.getCloneInList(0).should('have.css', 'color', 'rgb(108, 113, 196)')


\end{verbatim}

\question{ Now we will set its concentration to 1\% as expected. Click again on
  the star. In the \com{normalize to} field enter \com{1} and click \com{ok}.
  Now, in the graph, this clone should correspond to a straight line at 1\%.}
\begin{verbatim}
  /////////////////////////////////
  // test_B_clones_40_normalization
    cy.getCloneSize("1").should('have.text', "9.665%")

    cy.openTagPanelOneClone(1)
    cy.get('#norm_button').type("1{enter}")
    cy.getCloneSize("1").should('have.text', "1.000%")

    // need a refresh of the menu, call by hover
    cy.get('#settings_menu').invoke('trigger', "mouseover")
    cy.get('#settings_menu').invoke('trigger', "mouseout")
    cy.get('#settings_menu').invoke('trigger', "mouseenter")
    cy.get('#settings_menu').invoke('trigger', "mouseleave")
    cy.get('#settings_menu').invoke('show')

    cy.get("#normalizetest1").should("exist") // Form have the input for expected normalization"


\end{verbatim}

\question{ Notice how the concentrations of the other clones have changed
  accordingly.
  You can go to the \com{settings} menu to disable this normalization and to
  go back to the raw concentrations.}
\begin{verbatim}
  /////////////////////////////////////////
  // test_B_clones_41_disable_normalization
    cy.get("#reset_norm").click({force: true})
    cy.getCloneSize("1").should('have.text', "9.665%") //correct size after disabled normalization"

\end{verbatim}

Then you can set expected concentrations for other clones and you are free to
switch between those normalizations.
It is also possible to set up normalization against external data,
contact us if you are interested.

