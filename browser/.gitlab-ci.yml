
.test_cypress_base:
  image: vidjilci/cypress_with_browsers:latest
  stage: test_cypress_client
  # extends:
    # - .need_for_staged_client
  script:
    - echo -e "Run cypress with browser $BROWSER"
    - echo -e "PWD $PWD; CYPRESS_PATH $CYPRESS_PATH"
    # Create doc support files for testing
    - python tools/org-babel-tangle.py --all doc/vidjil-format.md
    - mv analysis-example1.vidjil  analysis-example2.analysis  analysis-example2.vidjil doc/
    # Cypress
    - bash docker/ci/script_preprocess.bash
    - cd /app
    - bash script.bash
  variables:
    BROWSER: electron
    CYPRESS_PATH: browser/test/cypress
    HOST: html
  artifacts:
    reports:
      junit: $CYPRESS_PATH/reports/test-cypress-*.xml
    paths:
      - $CYPRESS_PATH
    expire_in: 7 day
    when: always
  tags:
    - cidocker
  only:
    - /^feature-.*c.*\/.*$/
    - /^hotfix-.*c.*\/.*$/


## cypress client
# For the moment, need to be into separate stage (https://gitlab.com/gitlab-org/gitlab/-/issues/30632)
client_early:
  extends:
    - .test_cypress_base
    - .need_for_moderate_client
  variables:
    BROWSER: browsers/firefox_supported/firefox

client_late:
  extends:
    - .test_cypress_base
  parallel:
    matrix:
      - BROWSER: [
          browsers/firefox_latest/firefox,
          browsers/firefox_legacy/firefox,
          browsers/chrome_supported/chrome,
          browsers/chrome_latest/chrome,
          browsers/chrome_legacy/chrome
        ]
